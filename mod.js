function e(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function t(e){if(Array.isArray(e))return e}function n(e,t,n,r,i,o,a){try{var s=e[o](a);var c=s.value}catch(e){n(e);return}if(s.done){t(c)}else{Promise.resolve(c).then(r,i)}}function r(e){return function(){var t=this,r=arguments;return new Promise(function(i,o){var a=e.apply(t,r);function s(e){n(a,i,o,s,c,"next",e)}function c(e){n(a,i,o,s,c,"throw",e)}s(undefined)})}}function i(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function a(e,t,n){if(t)o(e.prototype,t);if(n)o(e,n);return e}function s(e,t,n){if(t in e){Object.defineProperty(e,t,{value:n,enumerable:true,configurable:true,writable:true})}else{e[t]=n}return e}function c(e,t){if(t!=null&&typeof Symbol!=="undefined"&&t[Symbol.hasInstance]){return!!t[Symbol.hasInstance](e)}else{return e instanceof t}}function l(e,t){var n=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(n==null)return;var r=[];var i=true;var o=false;var a,s;try{for(n=n.call(e);!(i=(a=n.next()).done);i=true){r.push(a.value);if(t&&r.length===t)break}}catch(e){o=true;s=e}finally{try{if(!i&&n["return"]!=null)n["return"]()}finally{if(o)throw s}}return r}function u(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function d(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};var r=Object.keys(n);if(typeof Object.getOwnPropertySymbols==="function"){r=r.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))}r.forEach(function(t){s(e,t,n[t])})}return e}function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);if(t){r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})}n.push.apply(n,r)}return n}function g(e,t){t=t!=null?t:{};if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(t))}else{f(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function h(e,n){return t(e)||l(e,n)||p(e,n)||u()}function y(e){"@swc/helpers - typeof";return e&&typeof Symbol!=="undefined"&&e.constructor===Symbol?"symbol":typeof e}function p(t,n){if(!t)return;if(typeof t==="string")return e(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);if(r==="Object"&&t.constructor)r=t.constructor.name;if(r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return e(t,n)}function b(e,t){var n,r,i,o,a={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),"throw":s(1),"return":s(2)},typeof Symbol==="function"&&(o[Symbol.iterator]=function(){return this}),o;function s(e){return function(t){return c([e,t])}}function c(o){if(n)throw new TypeError("Generator is already executing.");while(a)try{if(n=1,r&&(i=o[0]&2?r["return"]:o[0]?r["throw"]||((i=r["return"])&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;if(r=0,i)o=[o[0]&2,i.value];switch(o[0]){case 0:case 1:i=o;break;case 4:a.label++;return{value:o[1],done:false};case 5:a.label++;r=o[1];o=[0];continue;case 7:o=a.ops.pop();a.trys.pop();continue;default:if(!(i=a.trys,i=i.length>0&&i[i.length-1])&&(o[0]===6||o[0]===2)){a=0;continue}if(o[0]===3&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(o[0]===6&&a.label<i[1]){a.label=i[1];i=o;break}if(i&&a.label<i[2]){a.label=i[2];a.ops.push(o);break}if(i[2])a.ops.pop();a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e];r=0}finally{n=i=0}if(o[0]&5)throw o[1];return{value:o[0]?o[1]:void 0,done:true}}}import{applyParamsToScript as m,C as v,Constr as w,Data as S,Emulator as O,fromHex as B,fromText as T,fromUnit as x,generateSeedPhrase as I,getAddressDetails as k,Lucid as P,paymentCredentialOf as C,toLabel as E,toText as j,toUnit as A,Tx as D}from"./lucid-cardano/mod.js";var L=await P.new();function U(e){return E(222)+T("Bud".concat(e))}function _(e){return T("Berry".concat(e))}function N(e){return T("Matrix".concat(e))}function F(e,t){return e.assets.lovelace>t.assets.lovelace?-1:e.assets.lovelace<t.assets.lovelace?1:0}function K(e,t){return e.assets.lovelace>t.assets.lovelace?1:e.assets.lovelace<t.assets.lovelace?-1:0}function M(e){var t=e.address,n=e.data;var r,i;var o=k(t||H(n,L)),a=o.paymentCredential;return((r=a)===null||r===void 0?void 0:r.type)==="Key"?v.Ed25519KeyHash.from_hex(a.hash).to_bech32("addr_vkh"):((i=a)===null||i===void 0?void 0:i.type)==="Script"?v.ScriptHash.from_hex(a.hash).to_bech32("script"):""}function q(e){var t;var n=k(e),r=n.paymentCredential,i=n.stakeCredential;if(!r)throw new Error("Not a valid payment address.");return{paymentCredential:((t=r)===null||t===void 0?void 0:t.type)==="Key"?{PublicKeyCredential:[r.hash]}:{ScriptCredential:[r.hash]},stakeCredential:i?{Inline:[i.type==="Key"?{PublicKeyCredential:[i.hash]}:{ScriptCredential:[i.hash]}]}:null}}function H(e,t){var n=function(){return"PublicKeyCredential"in e.paymentCredential?t.utils.keyHashToCredential(e.paymentCredential.PublicKeyCredential[0]):t.utils.scriptHashToCredential(e.paymentCredential.ScriptCredential[0])}(),r=function(){if(!!e.stakeCredential&&"Inline"in e.stakeCredential)return"PublicKeyCredential"in e.stakeCredential.Inline[0]?t.utils.keyHashToCredential(e.stakeCredential.Inline[0].PublicKeyCredential[0]):t.utils.scriptHashToCredential(e.stakeCredential.Inline[0].ScriptCredential[0])}();return t.utils.credentialToAddress(n,r)}function R(e){var t=new Map;e.lovelace&&t.set("",new Map([["",e.lovelace]]));var n=Object.keys(e);return Array.from(new Set(n.filter(function(e){return e!=="lovelace"}).map(function(e){return e.slice(0,56)}))).sort().forEach(function(r){var i=n.filter(function(e){return e.slice(0,56)===r}),o=new Map;i.sort().forEach(function(t){o.set(t.slice(56),e[t])}),t.set(r,o)}),t}function V(e){var t;var n={lovelace:((t=e.get(""))===null||t===void 0?void 0:t.get(""))||0n};var r=true,i=false,o=undefined,a=true,s=false,c=undefined;try{for(var l=e[Symbol.iterator](),u;!(a=(u=l.next()).done);a=true){var d=h(u.value,2),f=d[0],g=d[1];if(f!=="")try{for(var y=g[Symbol.iterator](),p;!(r=(p=y.next()).done);r=true){var b=h(p.value,2),m=b[0],v=b[1];n[f+m]=v}}catch(e){i=true;o=e}finally{try{if(!r&&y.return!=null){y.return()}}finally{if(i){throw o}}}}}catch(e){s=true;c=e}finally{try{if(!a&&l.return!=null){l.return()}}finally{if(s){throw c}}}return n}var W=S.Enum([S.Object({PublicKeyCredential:S.Tuple([S.String])}),S.Object({ScriptCredential:S.Tuple([S.String])})]),Y=S.Enum([S.Object({Inline:S.Tuple([W])}),S.Object({Pointer:S.Tuple([S.Object({slotNumber:S.BigInt,transactionIndex:S.BigInt,certificateIndex:S.BigInt})])})]),z=S.Object({paymentCredential:W,stakeCredential:S.Nullable(Y)}),G=S.Map(S.String,S.Map(S.String,S.BigInt)),J=S.Enum([S.Object({Included:S.Tuple([S.String])}),S.Object({Excluded:S.Tuple([S.String])})]),$=S.Enum([S.Object({SpecificValue:S.Tuple([G])}),S.Object({SpecificSymbolWithConstraints:S.Tuple([S.String,S.Array(S.String),S.Array(J)])})]),Q=S.Object({txHash:S.Object({hash:S.String}),outputIndex:S.BigInt}),X=S.Object({owner:z,requestedLovelace:S.BigInt,privateListing:S.Nullable(z)}),Z=S.Object({owner:z,requestedOption:$}),ee=S.Object({address:z,fee:S.BigInt,minFee:S.Nullable(S.BigInt),maxFee:S.Nullable(S.BigInt)}),et=S.Object({recipients:S.Array(ee),version:S.BigInt,extra:S.Any}),en=S.Object({policyId:S.String,assetName:S.String}),er=S.Object({outRef:Q}),ei=S.Enum([S.Literal("Sell"),S.Literal("Buy"),S.Literal("Cancel")]),eo=S.Enum([S.Object({Listing:S.Tuple([X])}),S.Object({Bid:S.Tuple([Z])})]),ea=S.Tuple([S.Nullable(S.String),en]),es=S.Object({lovelace:S.BigInt,assets:G},!1),ec=S.Object({owner:S.String,amount:S.BigInt,private:S.Boolean,tuple:S.Tuple([G]),tuple_constr:S.Tuple([G],!0),enum:S.Enum([S.Literal("Sell"),S.Literal("Buy"),S.Literal("Cancel")]),nullable:S.Nullable(S.BigInt),obj:S.Object({policyId:S.String,assetName:S.String}),arr:S.Nullable(S.Array(S.String)),map:G}),el=S.Object({epoRewards:G,duration:S.BigInt,bondSymbol:S.String,tokenName:S.String,bondAmount:S.BigInt,buffer:S.BigInt,otmFee:S.BigInt,stakeKey:Y,permissioned:S.Nullable(S.Tuple([S.String]))}),eu=S.Object({minEpoRewards:G,minPrepaid:S.BigInt,minBuffer:S.BigInt,bondSymbol:S.String,specificBond:S.Nullable(S.Object({currencySymbol:S.String,tokenName:S.String})),poolToken:S.String}),ed=S.Object({bondSymbol:S.String,bondToken:S.String,poolToken:S.String}),ef=S.Object({epoRewards:G,duration:S.BigInt,bondSymbol:S.String,tokenName:S.String,bondAmount:S.BigInt,buffer:S.BigInt,otmFee:S.BigInt,ogLender:S.String,start:S.BigInt}),eg=S.Object({unknown:S.Array(S.Array(S.Any))}),eh=S.Object({zeroTime:S.BigInt,zeroSlot:S.BigInt,slotLength:S.BigInt}),ey=S.Object({bondPolicyId:S.String,escrowPolicyId:S.String,bondFaceValue:S.BigInt,yearToEpoch:S.BigInt,epochBoundary:S.BigInt,epochLength:S.BigInt,minPrepaid:S.BigInt,epochBoundaryAsEpoch:S.BigInt,marketFeeAddress:z,marketFeeBuyer:S.BigInt,marketFeeSeller:S.BigInt,SlotConfigNetwork:eh}),ep=S.Enum([S.Literal("Sell"),S.Literal("Update"),S.Literal("Buy")]),eb=S.Object({owner:z,requestedYield:S.BigInt}),em=S.Enum([S.Literal("Update"),S.Literal("Buy"),S.Literal("Sell")]),ev=S.Object({ownerPaymentKey:S.String,ownerStakeKey:S.Nullable(S.String),requestedYield:S.BigInt}),ew=S.Object({yearToEpoch:S.BigInt,epochBoundary:S.BigInt,epochBoundaryAsEpoch:S.BigInt,epochLength:S.BigInt,epochLengthBase:S.BigInt}),eS=S.Object({bondPolicyId:S.String,escrowPolicyId:S.String,basisPointsRefUnit:S.BigInt,basisPointsMin:S.BigInt,basisPointsMax:S.BigInt,oneAda2Lovelace:S.BigInt,bondFaceValue:S.BigInt,epochConfig:ew}),eO=S.Object({address:z,buyerFee:S.BigInt,sellerFee:S.BigInt,sellValidSlot:S.Nullable(S.BigInt)}),eB=S.Object({bond:eS,market:eO,slotConfigNetwork:eh}),eT=S.Tuple([eB]),ex=S.Object({owner:z,fromEpoch:S.BigInt,toEpoch:S.BigInt,quantity:S.BigInt,requestedYield:S.BigInt});var eI=function(){"use strict";function e(t,n){i(this,e);Object.defineProperty(this,"lucid",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lucid=t,this.config=n}a(e,[{key:"buy",value:function e(e){var t=this;return r(function(){var n,r,i,o,a,s;return b(this,function(c){switch(c.label){case 0:n=new Date().getTime(),r=n+Number(t.config.market.sellValidSlot*t.config.slotConfigNetwork.slot_length);return[4,Promise.all(e.map(function(e){return t._buy(e.utxo,BigInt(e.qty),BigInt(n))}))];case 1:i=c.sent().reduce(function(e,t){return e.compose(t)},t.lucid.newTx()).validFrom(n).validTo(r);console.log({txValidFromUnixTime:n,txValidToUnixTime:r,txValidFromSlot:t.lucid.utils.unixTimeToSlot(n),txValidToSlot:t.lucid.utils.unixTimeToSlot(r)});return[4,t.lucid.newTx().compose(i).txBuilderBalance()];case 2:o=c.sent().build_tx();console.log({buyOrder:o.to_js_value()});return[4,t.lucid.newTx().compose(i).complete()];case 3:a=c.sent();console.log({tx:a.toString()});return[4,a.sign().complete()];case 4:s=c.sent();return[2,(console.log({txSigned:s.toString()}),s.submit())]}})})()}},{key:"sell",value:function e(e){var t=this;return r(function(){var n,r,i;return b(this,function(o){switch(o.label){case 0:return[4,Promise.all(e.map(function(e){var n=e.bidUtxo,r=e.assetName;return t._sell(n,r)}))];case 1:n=o.sent().reduce(function(e,t){return e.compose(t)},t.lucid.newTx());return[4,t.lucid.newTx().compose(n).complete()];case 2:r=o.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 3:i=o.sent();return[2,(console.log({txSigned:i.toString()}),i.submit())]}})})()}},{key:"list",value:function e(e,t,n){var i=this;return r(function(){var r,o,a,c;return b(this,function(l){switch(l.label){case 0:a=(o=i.lucid.newTx()).compose;return[4,i._list(s({},e,BigInt(t)),n)];case 1:return[4,a.apply(o,[l.sent()]).complete()];case 2:r=l.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 3:c=l.sent();return[2,(console.log({txSigned:c.toString()}),c.submit())]}})})()}},{key:"changeListing",value:function e(e,t,n,i){var o=this;return r(function(){var t,r,a,s,c,l,u,d,f,g,h,y;return b(this,function(p){switch(p.label){case 0:return[4,o.lucid.datumOf(e,ev)];case 1:t=p.sent();if(!("ownerPaymentKey"in t&&"requestedYield"in t))throw new Error("Not a listing UTxO");r={paymentCredential:{PublicKeyCredential:[t.ownerPaymentKey]},stakeCredential:t.ownerStakeKey?{Inline:[{PublicKeyCredential:[t.ownerStakeKey]}]}:null},a=H(r,o.lucid),s=C(a).hash;return[4,o.lucid.wallet.address()];case 2:c=p.sent();if(s!==C(c).hash)throw new Error("You are not the owner.");l=Object.keys(e.assets).find(function(e){return e.startsWith(o.config.bond.bondPolicyId)});if(!l)throw new Error("No listing token found.");if(e.assets[l]==BigInt(n)&&i==null)throw new Error("Listing unnecessary update.");i!=null&&t.requestedYield!=BigInt(i)&&(t.requestedYield=BigInt(i));return[4,o.getDeployedScripts()];case 3:u=p.sent(),d=S.to("Update",em),f=o.lucid.newTx().collectFrom([e],d).payToContract(e.address,{inline:S.to(t,ev)},Object.fromEntries([[l,BigInt(n)]])).addSignerKey(s).compose(u.trade?o.lucid.newTx().readFrom([u.trade]):o.lucid.newTx().attachSpendingValidator(o.config.tradeValidator));return[4,o.lucid.newTx().compose(f).txBuilderBalance()];case 4:g=p.sent().build_tx();console.log({changeOrder:g.to_js_value()});return[4,f.complete()];case 5:h=p.sent();console.log({tx:h.toString()});return[4,h.sign().complete()];case 6:y=p.sent();return[2,(console.log({txSigned:y.toString()}),y.submit())]}})})()}},{key:"bid",value:function e(e,t){var n=this;return r(function(){var r,i,o,a;return b(this,function(s){switch(s.label){case 0:o=(i=n.lucid.newTx()).compose;return[4,n._bid(e,t)];case 1:return[4,o.apply(i,[s.sent()]).complete()];case 2:r=s.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 3:a=s.sent();return[2,(console.log({txSigned:a.toString()}),a.submit())]}})})()}},{key:"bidOpen",value:function e(e,t){var n=this;return r(function(){var r,i,o,a;return b(this,function(s){switch(s.label){case 0:o=(i=n.lucid.newTx()).compose;return[4,n._bidOpen(e,t)];case 1:return[4,o.apply(i,[s.sent()]).complete()];case 2:r=s.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 3:a=s.sent();return[2,(console.log({txSigned:a.toString()}),a.submit())]}})})()}},{key:"bidSwap",value:function e(e,t){var n=this;return r(function(){var r,i,o,a;return b(this,function(s){switch(s.label){case 0:o=(i=n.lucid.newTx()).compose;return[4,n._bidSwap(e,t)];case 1:return[4,o.apply(i,[s.sent()]).complete()];case 2:r=s.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 3:a=s.sent();return[2,(console.log({txSigned:a.toString()}),a.submit())]}})})()}},{key:"changeBid",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,s,c,l;return b(this,function(u){switch(u.label){case 0:return[4,n.lucid.datumOf(e,eo)];case 1:r=u.sent();if(!("Bid"in r))throw new Error("Not a bidding UTxO");if(Object.keys(e.assets).length>2)throw new Error("Cannot change swap bids.");i=H(r.Bid[0].owner,n.lucid),o=C(i).hash;return[4,n.lucid.wallet.address()];case 2:a=u.sent();if(o!==C(a).hash)throw new Error("You are not the owner.");return[4,n.getDeployedScripts()];case 3:s=u.sent();return[4,n.lucid.newTx().collectFrom([e],S.to("Update",em)).payToContract(e.address,{inline:e.datum},g(d({},e.assets),{lovelace:t})).addSignerKey(o).compose(s.trade?n.lucid.newTx().readFrom([s.trade]):n.lucid.newTx().attachSpendingValidator(n.config.tradeValidator)).complete()];case 4:c=u.sent();console.log({tx:c.toString()});return[4,c.sign().complete()];case 5:l=u.sent();return[2,(console.log({txSigned:l.toString()}),l.submit())]}})})()}},{key:"cancelListing",value:function e(e){var t=this;return r(function(){var n,r,i,o;return b(this,function(a){switch(a.label){case 0:i=(r=t.lucid.newTx()).compose;return[4,t._cancelListing(e)];case 1:return[4,i.apply(r,[a.sent()]).complete()];case 2:n=a.sent();console.log({tx:n.toString()});return[4,n.sign().complete()];case 3:o=a.sent();return[2,(console.log({txSigned:o.toString()}),o.submit())]}})})()}},{key:"cancelBid",value:function e(e){var t=this;return r(function(){var n,r,i,o;return b(this,function(a){switch(a.label){case 0:i=(r=t.lucid.newTx()).compose;return[4,t._cancelBid(e)];case 1:return[4,i.apply(r,[a.sent()]).complete()];case 2:n=a.sent();console.log({tx:n.toString()});return[4,n.sign().complete()];case 3:o=a.sent();return[2,(console.log({txSigned:o.toString()}),o.submit())]}})})()}},{key:"cancelListingAndSell",value:function e(e,t,n){var i=this;return r(function(){var r,o,a,s,c,l;return b(this,function(u){switch(u.label){case 0:a=(o=i.lucid.newTx()).compose;return[4,i._cancelListing(e)];case 1:c=(s=a.apply(o,[u.sent()])).compose;return[4,i._sell(t,n)];case 2:return[4,c.apply(s,[u.sent()]).complete()];case 3:r=u.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 4:l=u.sent();return[2,(console.log({txSigned:l.toString()}),l.submit())]}})})()}},{key:"cancelBidAndBuy",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,s,c;return b(this,function(l){switch(l.label){case 0:o=(i=n.lucid.newTx()).compose;return[4,n._cancelBid(e)];case 1:s=(a=o.apply(i,[l.sent()])).compose;return[4,n._buy(t,1n,BigInt(new Date().getTime()))];case 2:return[4,s.apply(a,[l.sent()]).complete()];case 3:r=l.sent();console.log({tx:r.toString()});return[4,r.sign().complete()];case 4:c=l.sent();return[2,(console.log({txSigned:c.toString()}),c.submit())]}})})()}},{key:"getAllListingsAndBids",value:function e(){var e=this;return r(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.lucid.utxosAt(C(e.config.tradeAddress))];case 1:return[2,t.sent().filter(function(t){return Object.keys(t.assets).filter(function(e){return e!=="lovelace"}).every(function(t){return t.startsWith(e.config.mintPolicyId)||t.startsWith(e.config.bond.bondPolicyId)})})]}})})()}},{key:"getListingOrBid",value:function e(e){var t=this;return r(function(){var n,r;return b(this,function(i){switch(i.label){case 0:return[4,t.lucid.utxosByOutRef([e])];case 1:n=h.apply(void 0,[i.sent(),1]),r=n[0];return[2,r||null]}})})()}},{key:"getListings",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.getListingsOfTradeAddress(e,t.config.tradeAddress)];case 1:return[2,n.sent()]}})})()}},{key:"getListingsOfTradeAddress",value:function e(e,t){var n=this;return r(function(){return b(this,function(r){switch(r.label){case 0:return[4,n.lucid.utxosAtWithUnit(C(t),A(n.config.bond.bondPolicyId,e))];case 1:return[2,r.sent().filter(function(e){var t=Object.keys(e.assets).filter(function(e){return e!=="lovelace"});return t.length>=1&&t.every(function(e){return e.startsWith(n.config.bond.bondPolicyId)})})]}})})()}},{key:"getBondInfos",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.utxosByUnit(A(t.config.bond.escrowPolicyId,e))];case 1:return[2,n.sent().filter(function(e){var n=Object.keys(e.assets).filter(function(e){return e!=="lovelace"});return n.every(function(e){return e.startsWith(t.config.bond.escrowPolicyId)})&&n.length>=1}).sort(K)]}})})()}},{key:"getMyBondInWallet",value:function e(){var e=this;return r(function(){return b(this,function(t){switch(t.label){case 0:return[4,e.lucid.wallet.getUtxos()];case 1:return[2,t.sent().filter(function(t){var n=Object.keys(t.assets).filter(function(e){return e!=="lovelace"});return n.some(function(t){return t.startsWith(e.config.bond.bondPolicyId)})&&n.length>=1}).map(function(t){return Object.entries(t.assets).filter(function(t){var n=h(t,2),r=n[0],i=n[1];return r!=="lovelace"&&r.startsWith(e.config.bond.bondPolicyId)&&i!=null&&i>0}).map(function(n){var r=h(n,2),i=r[0],o=r[1];return{outRef:{txHash:t.txHash,outputIndex:t.outputIndex},bondTokenId:i.replace(e.config.bond.bondPolicyId,""),quantity:o}})}).flat()]}})})()}},{key:"getBids",value:function e(e){var t=this;return r(function(){var n;return b(this,function(r){switch(r.label){case 0:n=function(){return e==="Open"?T("BidOpen"):e==="Swap"?T("BidSwap"):e==="Bundle"?T("BidBundle"):T("Bid")+e.assetName}();return[4,t.lucid.utxosAtWithUnit(C(t.config.tradeAddress),A(t.config.mintPolicyId,n))];case 1:return[2,r.sent().filter(function(n){var r=Object.keys(n.assets).filter(function(e){return e!=="lovelace"});return r.every(function(e){return e.startsWith(t.config.mintPolicyId)||e.startsWith(t.config.bond.bondPolicyId)})&&(e==="Swap"?r.length>1:r.length===1)}).sort(F)]}})})()}},{key:"utxoByUnit",value:function e(e,t){var n=this;return r(function(){return b(this,function(r){switch(r.label){case 0:return[4,n.lucid.utxoByUnit(A(e,t))];case 1:return[2,r.sent()]}})})()}},{key:"utxosByUnit",value:function e(e,t){var n=this;return r(function(){return b(this,function(r){switch(r.label){case 0:return[4,n.lucid.utxosByUnit(A(e,t))];case 1:return[2,r.sent()]}})})()}},{key:"utxosMintByUnit",value:function e(e,t){var n=this;return r(function(){return b(this,function(r){switch(r.label){case 0:return[4,n.lucid.utxosMintByUnit(A(e,t))];case 1:return[2,r.sent()]}})})()}},{key:"getUtxosByHash",value:function e(e,t){var n=this;return r(function(){var r;return b(this,function(i){switch(i.label){case 0:return[4,n.lucid.utxosByHash(e)];case 1:r=i.sent();return[2,(t?r.filter(function(e){return Object.keys(e.assets).filter(function(e){return e!=="lovelace"})}):r).sort(F)]}})})()}},{key:"optimOpenDatumOf",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,ef)];case 1:return[2,n.sent()]}})})()}},{key:"optimOpenPoolDatumOf",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,eu)];case 1:return[2,n.sent()]}})})()}},{key:"optimClosedPoolDatumOf",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,ed)];case 1:return[2,n.sent()]}})})()}},{key:"optimBondWriterDatumOf",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,el)];case 1:return[2,n.sent()]}})})()}},{key:"balanceOf",value:function e(e){var t=S.deserialize(v.PlutusData.from_bytes(B(e)));return(typeof t==="undefined"?"undefined":y(t))=="bigint"?{lovelace:t}:S.castFrom(t,es)}},{key:"addressOf",value:function e(e){return this.lucid.utils.getAddressDetails(e)}},{key:"listingDatumOfDanogo",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,ev)];case 1:return[2,n.sent()]}})})()}},{key:"listingDatumOf",value:function e(e){var t=this;return r(function(){return b(this,function(n){switch(n.label){case 0:return[4,t.lucid.datumOf(e,eb)];case 1:return[2,n.sent()]}})})()}},{key:"getDeployedScriptsOfHash",value:function e(e){var t=this;return r(function(){var n,r;return b(this,function(i){switch(i.label){case 0:if(!e)return[2,{trade:null}];return[4,t.lucid.utxosByOutRef([{txHash:e,outputIndex:0}])];case 1:n=h.apply(void 0,[i.sent(),1]),r=n[0];return[2,{trade:r}]}})})()}},{key:"getDeployedScripts",value:function e(){var e=this;return r(function(){var t;return b(this,function(n){switch(n.label){case 0:if(!e.config.deployHash)return[3,2];return[4,e.getDeployedScriptsOfHash(e.config.deployHash)];case 1:t=n.sent();return[3,3];case 2:t={trade:null};n.label=3;case 3:return[2,t]}})})()}},{key:"getContractHashes",value:function e(){return{scriptHash:this.config.tradeHash,bondPolicyId:this.config.bond.bondPolicyId,escrowPolicyId:this.config.bond.escrowPolicyId,bidPolicyId:this.config.mintPolicyId}}},{key:"_list",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,s,l,u,d;return b(this,function(f){switch(f.label){case 0:if(!(t>1&&t<9999))throw new Error("requested yield must be in range 1-9999");r=c(e,Array)?Object.fromEntries(e.map(function(e){return[e,1n]})):e;if(Object.keys(r).length<=0)throw new Error("Needs at least one asset.");return[4,n.lucid.wallet.address()];case 1:i=f.sent(),o=n.lucid.utils.getAddressDetails(i),a=o.stakeCredential,s=a?n.lucid.utils.credentialToAddress(n.lucid.utils.scriptHashToCredential(n.config.tradeHash),a):n.config.tradeAddress,l=Object.fromEntries(Object.entries(r).map(function(e){var t=h(e,2),r=t[0],i=t[1];return[A(n.config.bond.bondPolicyId,r),i]})),u=n.getOwnerAddressInfo(q(i));if(u.paymentKey.type=="Script")throw new Error("Not support wallet address with payment key is script type");d=S.to({ownerPaymentKey:u.paymentKey.hash,ownerStakeKey:u.stakeKey?u.stakeKey.hash:null,requestedYield:BigInt(t)},ev);return[2,n.lucid.newTx().payToContract(s,{inline:d},l)]}})})()}},{key:"getOwnerAddressInfo",value:function e(e){var t=this;return{paymentKey:function(){return"PublicKeyCredential"in e.paymentCredential?t.lucid.utils.keyHashToCredential(e.paymentCredential.PublicKeyCredential[0]):t.lucid.utils.scriptHashToCredential(e.paymentCredential.ScriptCredential[0])}(),stakeKey:function(){if(!!e.stakeCredential&&"Inline"in e.stakeCredential)return"PublicKeyCredential"in e.stakeCredential.Inline[0]?t.lucid.utils.keyHashToCredential(e.stakeCredential.Inline[0].PublicKeyCredential[0]):t.lucid.utils.scriptHashToCredential(e.stakeCredential.Inline[0].ScriptCredential[0])}()}}},{key:"_bid",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,l,u,d,f,g;return b(this,function(y){switch(y.label){case 0:r=c(e,Array)?Object.fromEntries(e.map(function(e){return[e,1n]})):e,i=Object.keys(r);if(i.length<=0)throw new Error("Needs at least one asset name.");return[4,n.lucid.wallet.address()];case 1:o=y.sent(),a=n.lucid.utils.getAddressDetails(o),l=a.stakeCredential,u=Object.fromEntries(Object.entries(r).map(function(e){var t=h(e,2),r=t[0],i=t[1];return[A(n.config.bond.bondPolicyId,r),i]})),d=i.length>1?T("BidBundle"):T("Bid")+i[0],f=l?n.lucid.utils.credentialToAddress(n.lucid.utils.scriptHashToCredential(n.config.tradeHash),l):n.config.tradeAddress,g={Bid:[{owner:q(o),requestedOption:{SpecificValue:[R(u)]}}]};return[2,n.lucid.newTx().mintAssets(s({},A(n.config.mintPolicyId,d),1n)).payToContract(f,{inline:S.to(g,eo)},s({lovelace:t},A(n.config.mintPolicyId,d),1n)).validFrom(n.lucid.utils.slotToUnixTime(1e3)).attachMintingPolicy(n.config.mintPolicy)]}})})()}},{key:"_bidOpen",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,c,l,u;return b(this,function(d){switch(d.label){case 0:return[4,n.lucid.wallet.address()];case 1:o=d.sent(),a=n.lucid.utils.getAddressDetails(o),c=a.stakeCredential,l=c?n.lucid.utils.credentialToAddress(n.lucid.utils.scriptHashToCredential(n.config.tradeHash),c):n.config.tradeAddress,u={Bid:[{owner:q(o),requestedOption:{SpecificSymbolWithConstraints:[n.config.bond.bondPolicyId,((r=t)===null||r===void 0?void 0:r.types)?t.types.map(T):[],((i=t)===null||i===void 0?void 0:i.traits)?t.traits.map(function(e){var t=e.negation,n=e.trait;return t?{Excluded:[T(n)]}:{Included:[T(n)]}}):[]]}}]};return[2,n.lucid.newTx().mintAssets(s({},A(n.config.mintPolicyId,T("BidOpen")),1n)).payToContract(l,{inline:S.to(u,eo)},s({lovelace:e},A(n.config.mintPolicyId,T("BidOpen")),1n)).validFrom(n.lucid.utils.slotToUnixTime(1e3)).attachMintingPolicy(n.config.mintPolicy)]}})})()}},{key:"_bidSwap",value:function e(e,t){var n=this;return r(function(){var r,i,o,a,c,l,u,f;return b(this,function(h){switch(h.label){case 0:if([t.constraints,t.specific].filter(function(e){return e}).length!==1)throw new Error("You can/must have either constraints or a specific request.");if(e.assetNames.length<=0)throw new Error("Needs at least one offering asset name.");if(t.specific&&t.specific.length<=0)throw new Error("Needs at least one requesting asset name.");return[4,n.lucid.wallet.address()];case 1:o=h.sent(),a=n.lucid.utils.getAddressDetails(o),c=a.stakeCredential,l=c?n.lucid.utils.credentialToAddress(n.lucid.utils.scriptHashToCredential(n.config.tradeHash),c):n.config.tradeAddress,u={Bid:[{owner:q(o),requestedOption:t.specific?{SpecificValue:[R(Object.fromEntries(t.specific.map(function(e){return[A(n.config.bond.bondPolicyId,e),1n]})))]}:{SpecificSymbolWithConstraints:[n.config.bond.bondPolicyId,((r=t.constraints)===null||r===void 0?void 0:r.types)?t.constraints.types.map(T):[],((i=t.constraints)===null||i===void 0?void 0:i.traits)?t.constraints.traits.map(function(e){var t=e.negation,n=e.trait;return t?{Excluded:[T(n)]}:{Included:[T(n)]}}):[]]}}]},f=Object.fromEntries(e.assetNames.map(function(e){return[A(n.config.bond.bondPolicyId,e),1n]}));return[2,(e.lovelace&&(f.lovelace=e.lovelace),n.lucid.newTx().mintAssets(s({},A(n.config.mintPolicyId,T("BidSwap")),1n)).payToContract(l,{inline:S.to(u,eo)},g(d({},f),s({},A(n.config.mintPolicyId,T("BidSwap")),1n))).validFrom(n.lucid.utils.slotToUnixTime(1e3)).attachMintingPolicy(n.config.mintPolicy))]}})})()}},{key:"getOwnerAddressOfListingDatum",value:function e(e){var t={paymentCredential:{PublicKeyCredential:[e.ownerPaymentKey]},stakeCredential:e.ownerStakeKey?{Inline:[{PublicKeyCredential:[e.ownerStakeKey]}]}:null};return H(t,this.lucid)}},{key:"_cancelListing",value:function e(e){var t=this;return r(function(){var n,r,i,o,a;return b(this,function(s){switch(s.label){case 0:return[4,t.lucid.datumOf(e,ev)];case 1:n=s.sent();if(!("ownerPaymentKey"in n&&"requestedYield"in n))throw new Error("Not a listing UTxO");r=t.getOwnerAddressOfListingDatum(n),i=C(r).hash;return[4,t.lucid.wallet.address()];case 2:o=s.sent();if(i!==C(o).hash)throw new Error("You are not the owner.");return[4,t.getDeployedScripts()];case 3:a=s.sent();return[2,t.lucid.newTx().collectFrom([e],S.to("Update",em)).addSignerKey(i).compose(a.trade?t.lucid.newTx().readFrom([a.trade]):t.lucid.newTx().attachSpendingValidator(t.config.tradeValidator))]}})})()}},{key:"_sell",value:function e(e,t){var n=this;return r(function(){var i,o,a,c,l,u,d,f,g,h,y,p,m,v;return b(this,function(w){switch(w.label){case 0:return[4,n.lucid.datumOf(e,eo)];case 1:i=w.sent();if(!("Bid"in i))throw new Error("Not a bidding UTxO");o=i.Bid[0],a=e.assets,c=a.lovelace,l=Object.keys(e.assets).find(function(e){return e.startsWith(n.config.mintPolicyId)});if(!l)throw new Error("No bid token found.");u=H(o.owner,n.lucid),d=function(){if("SpecificValue"in o.requestedOption)return{requestedAssets:V(o.requestedOption.SpecificValue[0]),refNFT:null};if("SpecificSymbolWithConstraints"in o.requestedOption&&t){var e=o.requestedOption.SpecificSymbolWithConstraints[0],n=A(e,x(A(e,t)).name,100),r=o.requestedOption.SpecificSymbolWithConstraints[1],i=o.requestedOption.SpecificSymbolWithConstraints[2];return{requestedAssets:s({},A(e,t),1n),refNFT:r.length>0||i.length>0?n:null}}throw new Error("No variant matched.")}(),f=d.requestedAssets,g=d.refNFT,h=S.to({outRef:{txHash:{hash:e.txHash},outputIndex:BigInt(e.outputIndex)}},er);return[4,n.getDeployedScripts()];case 2:y=w.sent();m=(p=n.lucid.newTx().collectFrom([e],S.to("Sell",em))).compose;if(!g)return[3,4];return[4,r(function(){var e;return b(this,function(t){switch(t.label){case 0:return[4,n.lucid.utxoByUnit(g)];case 1:e=t.sent();if(!e)throw new Error("This NFT doesn't support CIP-0068");return[2,n.lucid.newTx().readFrom([e])]}})})()];case 3:v=w.sent();return[3,5];case 4:v=null;w.label=5;case 5:return[2,m.apply(p,[v]).compose(n._payFee(c,h).tx).payToAddressWithData(u,{inline:h},f).mintAssets(s({},l,-1n)).validFrom(n.lucid.utils.slotToUnixTime(1e3)).compose(y.trade?n.lucid.newTx().readFrom([y.trade]):n.lucid.newTx().attachSpendingValidator(n.config.tradeValidator)).attachMintingPolicy(n.config.mintPolicy)]}})})()}},{key:"_cancelBid",value:function e(e){var t=this;return r(function(){var n,r,i,o,a,c,l;return b(this,function(u){switch(u.label){case 0:return[4,t.lucid.datumOf(e,eo)];case 1:n=u.sent();if(!("Bid"in n))throw new Error("Not a bidding UTxO");r=H(n.Bid[0].owner,t.lucid),i=C(r).hash;return[4,t.lucid.wallet.address()];case 2:o=u.sent();if(i!==C(o).hash)throw new Error("You are not the owner.");a=h(Object.keys(e.assets).filter(function(e){return e.startsWith(t.config.mintPolicyId)}),1),c=a[0];return[4,t.getDeployedScripts()];case 3:l=u.sent();return[2,t.lucid.newTx().collectFrom([e],S.to("Update",em)).mintAssets(s({},c,-1n)).validFrom(t.lucid.utils.slotToUnixTime(1e3)).addSignerKey(i).compose(l.trade?t.lucid.newTx().readFrom([l.trade]):t.lucid.newTx().attachSpendingValidator(t.config.tradeValidator)).attachMintingPolicy(t.config.mintPolicy)]}})})()}},{key:"_getMillisecondsOfDay",value:function e(){return this.config.bond.epochConfig.epochLength*86400000n/this.config.bond.epochConfig.epochLengthBase}},{key:"_relativeEpochToPosixTimeStart",value:function e(e){return(e-this.config.bond.epochConfig.epochBoundaryAsEpoch)*this.config.bond.epochConfig.epochLength+this.config.bond.epochConfig.epochBoundary}},{key:"_relativeEpochToPosixTimeEnd",value:function e(e){return this._relativeEpochToPosixTimeStart(e)+this.config.bond.epochConfig.epochLength}},{key:"_posixTimeToRelativeEpoch",value:function e(e){return(e-this.config.bond.epochConfig.epochBoundary)/this.config.bond.epochConfig.epochLength+this.config.bond.epochConfig.epochBoundaryAsEpoch}},{key:"_getCurrentEpoch",value:function e(){return this._posixTimeToRelativeEpoch(BigInt(new Date().getUTCMilliseconds()))}},{key:"_getDayToMaturity",value:function e(e,t){if(t>e)return 0n;{var n=this._getMillisecondsOfDay(),r=e-t,i=r/n;return r%n==0n?i:i+1n}}},{key:"_getPriceOfBond",value:function e(e,t,n){return e*this.config.bond.basisPointsRefUnit*this.config.bond.basisPointsRefUnit/(this.config.bond.basisPointsRefUnit*this.config.bond.basisPointsRefUnit+n*this.config.bond.basisPointsRefUnit*(t<0n?0n:t)/365n)}},{key:"_getEscrowInfo",value:function e(e,t,n){var r;var i=t.start+this.config.bond.epochConfig.epochBoundaryAsEpoch,o=i+t.duration,a=(r=t.epoRewards.get(""))===null||r===void 0?void 0:r.get("");if(a==null)throw new Error("Not found Epoch Rewards in Escrow Datum.");var s=t.bondAmount*this.config.bond.bondFaceValue,c=e-s,l=this._posixTimeToRelativeEpoch(n),u=l-i+1n,d=u*a,f=(c-d)/a;if(f<t.buffer&&l>=o)throw new Error("This Bond is CLOSABLE");var g=this.config.bond.basisPointsRefUnit-t.otmFee,h=BigInt(a)*t.duration*g;return{bondAmount:t.bondAmount,escrowBalance:e,principal:s,premiumPaid:c,epochRewards:a,escrowDatumStart:t.start,epochStart:i,bondDuration:t.duration,epochMaturity:o,currentEpoch:l,totalDuePaidEpoch:u,totalDuePaidValue:d,interestLevelEpoch:f,lendAfterFee:g,lenderInterest:h,receivedAtMaturityOneBond:h/this.config.bond.basisPointsRefUnit/t.bondAmount+this.config.bond.bondFaceValue,dayToMaturity:this._getDayToMaturity(this._relativeEpochToPosixTimeEnd(o),n),txPosixTime:n}}},{key:"_buy",value:function e(e,t,n){var i=this;return r(function(){var r,o,a,s,c,l,u,d,f,g,h,y,p,m,v,w,O,B;return b(this,function(b){switch(b.label){case 0:return[4,i.lucid.wallet.address()];case 1:r=b.sent();if(r==i.config.market.address)throw new Error("Forbidden buy with fee address of market.");return[4,i.lucid.datumOf(e,ev)];case 2:o=b.sent();if(!("ownerPaymentKey"in o&&"requestedYield"in o))throw new Error("Not a listing UTxO");if(i.getOwnerAddressInfo(q(r)).paymentKey.hash==o.ownerPaymentKey)throw new Error("Forbidden buy with listing of yourself.");a=Object.keys(e.assets).find(function(e){return e.startsWith(i.config.bond.bondPolicyId)});if(!a)throw new Error("No listing token found.");s=e.assets[a];if(t<=0||t>s)throw new Error("Buy qty must be greater than zero and less than or equal to quantity of listing Utxo.");c=x(a);return[4,i.lucid.utxoByUnit(A(i.config.bond.escrowPolicyId,c.assetName))];case 3:l=b.sent();if(l==null)throw new Error("Not found Escrow Utxo.");return[4,i.lucid.datumOf(l,ef)];case 4:u=b.sent();if(u==null)throw new Error("Can't get Escrow Datum of listing UTxO");d=i._getEscrowInfo(l.assets.lovelace,u,n),f=d.receivedAtMaturityOneBond*t;console.log("dayToMaturity: ",d.dayToMaturity);g=i._getPriceOfBond(d.receivedAtMaturityOneBond,d.dayToMaturity,o.requestedYield)*t,h=f-g,y=h*i.config.market.feeSeller/i.config.bond.basisPointsRefUnit,p=h*i.config.market.feeBuyer/i.config.bond.basisPointsRefUnit,m=i.getOwnerAddressOfListingDatum(o),v=e.assets.lovelace,w=y+p+(t<s?0n:v),O=g-y;return[4,i.getDeployedScripts()];case 5:B=b.sent();return[2,i.lucid.newTx().collectFrom([e],S.to("Buy",em)).payToAddress(i.config.market.address,{lovelace:w}).payToAddress(m,{lovelace:O}).compose(function(){return t<s?i.lucid.newTx().payToContract(e.address,{inline:S.to(o,ev)},Object.fromEntries([["lovelace",v],[a,s-t]])):i.lucid.newTx()}()).compose(B.trade?i.lucid.newTx().readFrom([B.trade]):i.lucid.newTx().attachSpendingValidator(i.config.tradeValidator)).readFrom([l])]}})})()}},{key:"_payFee",value:function e(e,t){var n=this.lucid.newTx(),r=e,i=this.config.market.address,o=this.config.market.feeBuyer,a=this.config.market.minFee,s=this.config.market.maxFee,c=e*10n/o,l=a&&c<a?a:s&&c>s?s:c;return r-=l,n.payToAddressWithData(i,{inline:t},{lovelace:l}),r=r<0n?0n:r,{tx:n,remainingLovelace:r}}}]);return e}();export{z as Address,es as Balance,$ as BidOption,ex as BiddingDatum,Z as BiddingDetails,ey as BondMarketConfig,eI as ContractBond,W as Credential,eS as DanogoBondConfig,ev as DanogoBondListingDatum,eO as DanogoBondMarketConfig,em as DanogoBondTradeAction,eB as DanogoConfig,ew as DanogoEpochConfig,eT as DanogoMarketParams,ep as ListingAction,eb as ListingDatum,X as ListingDetails,ec as ListingSample,Q as OutRef,eg as PBondUnknownDatum,el as PBondWriterDatum,ed as PClosedPoolDatum,ef as POpenDatum,eu as POpenPoolDatum,er as PaymentDatum,et as RoyaltyInfo,ee as RoyaltyRecipient,en as RoyaltyToken,eh as SlotConfigNetwork,Y as StakeCredential,ei as TradeAction,eo as TradeDatum,ea as TradeParams,J as TraitOption,G as Value,_ as colorToBerry,q as fromAddress,R as fromAssets,U as idToBud,N as idToMatrix,K as sortAsc,F as sortDesc,H as toAddress,V as toAssets,M as toOwner};